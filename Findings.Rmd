---
title: "Libraries Activity Pilot: Programmes and Events Analysis"
author: "Lee Durbin"
date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
theme: lumen
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("ggplot2")
library("ggthemes")
library("DT")

source("analysis.R")
```

```{r functions, include=FALSE}
plot_finishes <- function(g) {
  g + 
    geom_col() +
    theme_fivethirtyeight() +
    geom_text(aes(label=n), hjust=1.25, colour = "white") +
    coord_flip() +
    labs(x = "", y = "Number of sessions")
}
```

The Libraries Activity pilot took place between **Thursday February 25 2021 and Wednesday March 17 2021**. We invited users to enter data using two forms, one for Programmes and Events and one for Services. **38 individuals** participated in the pilot.

We received **214 entries** via the Programmes and Events form, and of those **79 included feedback**. We received **130 entries** via the Services form, and of those **28 included feedback**. In addition, we received **29 pieces of feedback** via a separate feedback form.

The following analysis looks at the entries provided via the Programmes and Events form.

## Inside a library vs outside a library

How many sessions were delivered inside a library vs outside a library?

```{r loction_is_lib_chart, echo = FALSE}
data <- df %>% 
  filter(!is.na(location_is_library)) %>% 
  count(location_is_library)
  
g <- ggplot(data, mapping = aes(x = reorder(location_is_library, n), y = n))

plot_finishes(g)
```

```{r loction_is_lib_table, echo = FALSE}
df %>% 
  filter(!is.na(location_is_library)) %>% 
    mutate(across(where(is.character) & !what_was_the_name_of_the_session, as.factor)) %>% 
  select(id, "Session Name" = what_was_the_name_of_the_session, "Location" = where_was_the_session_delivered, "Locatioon Group" = location_is_library, "Category" = how_would_you_categorise_this_session, "Content" = content) %>% 
  DT::datatable(
    caption = 'Sessions inside a community library vs outside a community library',
    filter = "top",
    rownames = FALSE,
    options = list(
      autoWidth = TRUE
    )
  )
```

## Delivery group

How many sessions were co-delivered, how many were delivered by a library, and how many were delivered by an external?

```{r delivery_group_chart, echo=FALSE}
data <- df %>% 
  count(delivery_group)

g <- ggplot(data, mapping = aes(x = reorder(delivery_group, n), y = n))

plot_finishes(g)

```

Of the sessions that were *not* co-delivered, how many were delivered by each delivery agent?

```{r delivery_entities_chart, echo=FALSE}
data <- df %>% 
  filter(was_the_session_co_delivered_with_other_library_teams_or_other_partners == "No") %>% 
  count(who_delivered_the_session)

g <- data %>% ggplot(mapping = aes(x = reorder(who_delivered_the_session, n), y = n))

plot_finishes(g)
```

Of the sessions that *were* co-delivered, how many were delivered by each delivery agent?

```{r co-delivery_entities, echo=FALSE}
data <- df %>% 
  filter(was_the_session_co_delivered_with_other_library_teams_or_other_partners == "Yes") %>% 
  count(with_whom_was_the_session_co_delivered)

g <- data %>% ggplot(mapping = aes(x = reorder(with_whom_was_the_session_co_delivered, n), y = n))

plot_finishes(g)
  
```

```{r delivery_group_table, echo=FALSE}
df %>% 
  mutate(across(where(is.character) & !what_was_the_name_of_the_session, as.factor)) %>% 
  select(id, "Session Name" = what_was_the_name_of_the_session, "Delivery agent" = who_delivered_the_session, "Co-delivery agents" = with_whom_was_the_session_co_delivered, "Delivery Group" = delivery_group, "Category" = how_would_you_categorise_this_session, "Content" = content) %>% 
  DT::datatable(
    caption = 'Sessions by delivery group',
    filter = "top",
    rownames = FALSE,
    options = list(
      autoWidth = TRUE
    )
  )
```

## Target audiences: Māori or Pasifika

Was the session designed to specifically benefit Māori or Pasifika?

```{r ethnic_groups, echo=FALSE}
data <- df %>% 
  count(was_the_session_designed_to_specifically_benefit_maori_or_pasifika)

g <- data %>% ggplot(mapping = aes(x = reorder(was_the_session_designed_to_specifically_benefit_maori_or_pasifika, -n), y = n))

plot_finishes(g)
  
```

Which community was the session designed to specifically benefit, Māori or Pasifika?

```{r maori_pasifika, echo=FALSE}
data <- df %>% 
  filter(was_the_session_designed_to_specifically_benefit_maori_or_pasifika == "Yes") %>% 
  count(which_community_was_the_session_designed_to_specifically_benefit)

g <- data %>% ggplot(mapping = aes(x = reorder(which_community_was_the_session_designed_to_specifically_benefit, n), y = n))

plot_finishes(g)
  
```

```{r ethnic_groups_table, echo=FALSE}
df %>% 
  filter(was_the_session_designed_to_specifically_benefit_maori_or_pasifika == "Yes") %>% 
  mutate(across(where(is.character) & !what_was_the_name_of_the_session, as.factor)) %>% 
  select(id, "Session Name" = what_was_the_name_of_the_session, "Māori, Pasifika, or both?" = which_community_was_the_session_designed_to_specifically_benefit, "Category" = how_would_you_categorise_this_session, "Content" = content) %>% 
  DT::datatable(
    caption = 'Sessions designed to specifically benefit Māori or Pasifika',
    filter = "top",
    rownames = FALSE,
    options = list(
      autoWidth = TRUE
    )
  )
```

## Target audiences: other communities

Was the session designed to specifically benefit other communities?

```{r other_communities, echo=FALSE}
data <- df %>% 
  count(was_the_session_designed_to_specifically_benefit_other_communities)

g <- data %>% ggplot(mapping = aes(x = reorder(was_the_session_designed_to_specifically_benefit_other_communities, -n), y = n))

plot_finishes(g)
```

```{r other_communities_list, echo=FALSE}
data <- df %>% 
  filter(!is.na(which_community_or_communities_was_the_session_designed_to_specifically_benefit)) %>% 
  select(id, which_community_or_communities_was_the_session_designed_to_specifically_benefit) %>% 
  mutate(other_communities_tidied = strsplit(as.character(which_community_or_communities_was_the_session_designed_to_specifically_benefit), ",")) %>%
  unnest(other_communities_tidied) %>%
  mutate(other_communities_tidied = str_replace_all(other_communities_tidied, c('"'), "")) %>%
  mutate(other_communities_tidied = str_replace_all(other_communities_tidied, '\\[', "")) %>%
  mutate(other_communities_tidied = str_replace_all(other_communities_tidied, '\\]', "")) %>% 
  mutate(communities_other = case_when(
    other_communities_tidied %in% other_communities$communities ~ other_communities_tidied,
    !other_communities_tidied %in% other_communities$communities ~ "Other",
  )
  ) %>% 
  count(communities_other)

g <- data %>% ggplot(mapping = aes(x = reorder(communities_other, n), y = n))

plot_finishes(g)
```

```{r other_communities_table, echo=FALSE}
df %>% 
  filter(was_the_session_designed_to_specifically_benefit_other_communities == "Yes") %>% 
  mutate(other_communities_tidied = strsplit(as.character(which_community_or_communities_was_the_session_designed_to_specifically_benefit), ",")) %>%
  unnest(other_communities_tidied) %>%
  mutate(other_communities_tidied = str_replace_all(other_communities_tidied, c('"'), "")) %>%
  mutate(other_communities_tidied = str_replace_all(other_communities_tidied, '\\[', "")) %>%
  mutate(other_communities_tidied = str_replace_all(other_communities_tidied, '\\]', "")) %>% 
  mutate(communities_other = case_when(
    other_communities_tidied %in% other_communities$communities ~ "Selection",
    !other_communities_tidied %in% other_communities$communities ~ "Other",
  )
  ) %>% 
  mutate(across(where(is.character) & !what_was_the_name_of_the_session, as.factor)) %>% 
  select(id, "Session Name" = what_was_the_name_of_the_session, "Communities" = other_communities_tidied, "Communities Other?" = communities_other, "Category" = how_would_you_categorise_this_session, "Content" = content) %>% 
  DT::datatable(
    caption = 'Sessions designed to specifically benefit other communities',
    filter = "top",
    rownames = FALSE,
    options = list(
      autoWidth = TRUE
    )
  )
```

## Target audiences: age groups

Was the session designed to specifically benefit a target age group?

```{r target_age_group, echo=FALSE}
data <- df %>% 
  count(was_the_activity_designed_to_specifically_benefit_a_target_age_group)

g <- data %>% ggplot(mapping = aes(x = reorder(was_the_activity_designed_to_specifically_benefit_a_target_age_group, n), y = n))

plot_finishes(g)
```

What was the target age group for the session?

```{r age_groups, echo=FALSE}
data <- df %>% 
  filter(was_the_activity_designed_to_specifically_benefit_a_target_age_group == "Yes") %>% 
  count(what_was_the_target_age_group_for_the_session)

g <- data %>% ggplot(mapping = aes(x = reorder(what_was_the_target_age_group_for_the_session, n), y = n))

plot_finishes(g)
```

```{r age_groups_table, echo=FALSE}
df %>% 
  filter(was_the_activity_designed_to_specifically_benefit_a_target_age_group == "Yes") %>% 
  mutate(across(where(is.character) & !what_was_the_name_of_the_session, as.factor)) %>% 
  select(id, "Session Name" = what_was_the_name_of_the_session, "Age group" = what_was_the_target_age_group_for_the_session, "Category" = how_would_you_categorise_this_session, "Content" = content) %>% 
  DT::datatable(
    caption = 'Sessions by age group',
    filter = "top",
    rownames = FALSE,
    options = list(
      autoWidth = TRUE
    )
  )
```


## Categories and Content

How would you categorise this session?

```{r categories_chart, echo=FALSE}
data <- df %>% 
  filter(!is.na(how_would_you_categorise_this_session)) %>% 
  count(how_would_you_categorise_this_session)

g <- data %>% ggplot(mapping = aes(x = reorder(how_would_you_categorise_this_session, n), y = n))

plot_finishes(g)
```

What was the primary focus or content of this session?

```{r content_chart, echo=FALSE}
data <- df %>% 
  mutate(content = case_when(
    content_other == "Other" ~ "Other",
    content_other != "Other" ~ content
  )) %>% 
  count(content)

g <- data %>% ggplot(mapping = aes(x = reorder(content, n), y = n))

plot_finishes(g)
```

```{r category_content_table, echo=FALSE}
df %>% 
  filter(!is.na(how_would_you_categorise_this_session)) %>% 
  mutate(across(where(is.character) & !what_was_the_name_of_the_session, as.factor)) %>% 
  select(id, "Session Name" = what_was_the_name_of_the_session, "Category" = how_would_you_categorise_this_session, "Content" = content, "Content Other?" = content_other) %>% 
  DT::datatable(
    caption = 'Sessions by category and content',
    filter = "top",
    rownames = FALSE,
    options = list(
      autoWidth = TRUE
    )
  )
```

## Outreach

Was the session designed for and delivered to people that would not usually come to the library or community hub?

```{r outreach_overall, echo=FALSE}
data <- df %>% 
  count(was_the_session_designed_and_delivered_to_people_that_would_not_usually_come_to_the_library) 

g <- data %>% ggplot(mapping = aes(x = reorder(was_the_session_designed_and_delivered_to_people_that_would_not_usually_come_to_the_library, -n), y = n))

plot_finishes(g)
```

```{r outreach_table, echo=FALSE}
df %>% 
  mutate(across(where(is.character) & !what_was_the_name_of_the_session, as.factor)) %>% 
  filter(was_the_session_designed_and_delivered_to_people_that_would_not_usually_come_to_the_library == "Yes, this was an outreach activity") %>% 
  select(id, "Session Name" = what_was_the_name_of_the_session, "Location" = location, "Location group" = location_is_library) %>% 
  DT::datatable(
    caption = 'Outreach sessions and their locations',
    filter = "top",
    rownames = FALSE,
    options = list(
      autoWidth = TRUE
    )
  )
```

